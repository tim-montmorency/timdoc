var popup = new AppendPopup({
    title: "Exercice réussi!",
    text: "Félicitation, vous maîtrisez la maison",
    color: "#8D94BA",
    background: "https://i.giphy.com/media/l0IylQoMkcbZUbtKw/giphy.webp",
    ascii:`MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNXXXXNWWMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWX00000000KNWMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWKO0KKKKKK0OOXWMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMXkO0KKKKKKK0O0WMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMKkO0KKKKKKK0OOXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMW0xO00KKKKKK0kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMW0xk00KKKKKK0kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMWWNNNWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMW0xk00KKKKKK0kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMWK000000KXWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWOdk00KKKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMNOkk00KKK0O0XWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWOdk00KKKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMW0xkO00KKK00kOXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWOdk00KKKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMW0xkO00KKKK0OxOWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNOdk00KKKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMW0dxO00KKKK00kxXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWOdkO0KKKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMXxdkO0KKKK00kx0WMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNkdkO00KKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMNkdxO00KKKK0OxkXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNkoxO00KKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMW0ddk00KKKK0Oxx0WMMMMMMMMMMMMMMMMMWNXK00000XNXxoxkO0KKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMXkdxO0KKKK00kdONMMMWNXKKKKKXWWWX0OkxkkkkkkkOkoldkO0KKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMWOdxO0KKKKK0OxkXWWXOkkkkkkkkO0OxdxkOOO0000OOxlldkO00KKK00kkKMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMKxxO0KKKKK0Okx0N0xxkOO0000OkxlloxkO00000000OdlokO00KKK00kkKMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMNkdk00KKKK00OxkOddkO0000000Oxlcldk000000000OxlokO00KKK0OkkKMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMW0dx00KKKKK00Oxl:dO0000K000Oko:cok00K0KK0000kook00KKKK0OkxKWMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMXxxO00KKKKK00Oo:dO0000KK00Oko::lk00KKKKKKK0kddO00KKK00Okx0WMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMW0dk000KKKKK00xloO0000KKK00Odc:lk00KKKKKKK0OddO0KKKK00Okx0WMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMKxxO00KKKKKK0kook000KKKK00OxlclxOO0000000OkddO0KKK000OkxONMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMNkdk00KKKKKK0OxdkOOOO0OOOkxdoccldxxxxxxxxddodO00K000OOkxkXMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMW0dkO00KKKKK0OkdxxxxxxxxxxdddoooddxxxxkxxxddxkO0000OOOkxxKMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMW0xkO000000000kxddoodkO0000000000000000000000OOOOOOOOOkxx0WMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMWOdkO00000000OOxolclxO0000KKKKKKKKKKKKKKKKKKKK0000OkkxxxxOWMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMNOdkO00000000OOkdc;:okOO0O0000000000000000KKKKKKKK000OkxdxXMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMNOdkO000000000Okkdc;:oxkkkkkkkkkkkkkkkkkOO00KKKKKKKK0000OxOXWMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMNOdkOO00000000OOkxdolclodddxxxxxxxxdddxxkOO000KKKKKKKK000OkkKWMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMNOdkOO000000000Okxxdolc::::cclllllccclodxkkO000KKKKKKK000OOxkXMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMNOdkOO0000KKK00OOkxxddoc:;,,'''''''..',:ldxkOO00KKKKK0000OOxd0WMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMWOdxkO0000KKKK00OOkkxxddolcc:::;;;;,,,'',cxkOO000KKK00000OkxdOWMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMW0dxkOO000KKKKK000OOkkxxxddooooolllllc::;:okOO00KKKK00000Okdd0WMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMWKddkOO0000KKKKK0000OOOkkkxxxxxxxxxdddoooodkO00000K00000OOxddKMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMXxoxkOO0000KKKKK000000OOOOkkkkkkkkkkxxxxxxkOO000000000OOkdokNMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMWOodkOOO000000KKK00000000OOOOOOOOOOOOOOkkkOOO0000000OOkkxod0WMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMKxoxkOO0000000000K000000000000000OOOOOOOOOOOO0000OOOkxxookNMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMWOodxkOOO00000000000KK0000000000000OOOOOOOOOOOOOOOkkxdolxXMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMXkodxkOOO0000000000KKKK00000000000OOOOOOOOOOOOkkkxddoldKWMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMWXxodxkOOOO00000000000000000000000OOOOOOOOkkkkxxddooldKWMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMWXxodxxkOOOO00000000000000000000OOOOOOkkkkxxxddoollxXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMXkoodxxkkOOOOO000000000000000OOOOOkkkxxxdddoolloONMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMWKxooddxxkkOOOOOO000000000OOOOOkkkxxdddooolllxKWMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWKkoloodxxxkkkOOOOOOOOOOOOOkkxxdddooollcld0NMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXOdolloodddxxxxkkkkkkkxxxddooolllccokKNMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXOkxoolllllooooooooollllccccldk0NWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNXK0OOkkkkkxxxxxxxxkkO0KNWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWWWWWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM`});

var style = document.createElement('style');
style.innerHTML = `
html,
body {
  margin: 0;
  height: 100%;
}
body {
    background-position: 50% calc(50% - 60px);
    background-repeat: no-repeat;
    background-image: url(https://tim-montmorency.com/timdoc/582-215MO/css/transformation/exercices/formes/images/maison.png);
}
.slide {
    width: 200px;
    height: 200px;
    opacity: 0.5;
}
.slide.blue { background-color: #3c38ba;}
.slide.green { background-color: #00c774;}
.slide.red { background-color: #ff8487;}`;

document.head.appendChild(style);

function debounce(func, wait, immediate) {
	var timeout;
	return function() {
		var context = this, args = arguments;
		var later = function() {
			timeout = null;
			if (!immediate) func.apply(context, args);
		};
		var callNow = immediate && !timeout;
		clearTimeout(timeout);
		timeout = setTimeout(later, wait);
		if (callNow) func.apply(context, args);
	};
};

var blue = document.querySelector('.slide.blue');
var green = document.querySelector('.slide.green');
var red = document.querySelector('.slide.red');

// Options for the observer (which mutations to observe)
const config = { attributes: true, childList: true, subtree: true };

// Callback function to execute when mutations are observed
const callback = function (mutationsList, observer) {
   validate();
};

var validate = debounce(function () {
    var s1 = validateSlide(red, '-100', '-100', 0, '1', '1');
    if(s1) {
        var s2 = validateSlide3D(blue, '-170', '-200', '-45', '45', '0.7', '1.2');
        if(s2) {
            var s3 = validateSlide3D(green, '-30', '-200', '-45', '-45', '0.7', '1.2');
            if(s3) {
                // observer1.disconnect();
                popup.open();
            } else {
                console.log('%c green is invalid ', 'background: #00c774 ; color: #fff;');
            }
        } else {
            console.log('%c blue is invalid ', 'background: #3c38ba; color: #fff;');
        }
    } else {
        console.log('%c red is invalid ', 'background: #ff8487; color: #fff;');
    }
}, 100);



var validateSlide = function(el, x, y, angle, scaleX, scaleY) {
    var styles = window.getComputedStyle(el, null);
    var matrix = getMatrix(styles);

    if (!validateTranslate(matrix, x, y, styles)) return false;
    if (!validateRotate(matrix, angle)) return false;
    if (!validateSkew(el, scaleX, scaleY)) return false;

    return true;
}

var validateSlide3D = function(el, x, y, rotateX, rotateY, scaleX, scaleY) {
    var styles = window.getComputedStyle(el, null);
    var matrix = getMatrix(styles);

    if (!validateTranslate3D(matrix, x, y, styles)) return false;
    if (!validateRotateX(matrix, rotateX)) return false;
    if (!validateRotateY(matrix, rotateY)) return false;
    if (!validateSkew(el, scaleX, scaleY)) return false;

    return true;
}

var validateTranslate = function(matrix, desiredX, desiredY, styles) {
    if (desiredX === '0' && desiredY === '0') {
        if (matrix) {
            if (matrix[4] !== 0 && matrix[5] !== 0) return false;
        } 
    } else {
        if (desiredX === '-100' && desiredY === '-100') { // centré
            if (matrix) {
                if (styles.top === '0px' || styles.bottom === '0px' || styles.left === '0px' || styles.right === '0px') {
                    if (parseFloat(matrix[4]) !== 0 && parseFloat(matrix[5]) !== 0) return false;
                } else {
                    if(matrix[4] !== desiredX) return false;
                    if(matrix[5] !== desiredY) return false;
                }
            } else {
                if (styles.top !== '0px' || styles.bottom !== '0px' || styles.left !== '0px' || styles.right !== '0px') return false;
            }
        } else {
            if (!matrix) return false;
            if(matrix[4] !== desiredX) return false;
            if(matrix[5] !== desiredY) return false;
        }
    }

    return true;
}

var validateTranslate3D = function(matrix, desiredX, desiredY, styles) {
    if (desiredX === '0' && desiredY === '0') {
        if (matrix) {
            if (matrix[12] !== 0 && matrix[13] !== 0) return false;
        } 
    } else {
        if (desiredX === '-100' && desiredY === '-100') { // centré
            if (matrix) {
                if (styles.top === '0px' || styles.bottom === '0px' || styles.left === '0px' || styles.right === '0px') {
                    if (parseFloat(matrix[4]) !== 0 && parseFloat(matrix[5]) !== 0) return false;
                } else {
                    if(matrix[12] !== desiredX) return false;
                    if(matrix[13] !== desiredY) return false;
                }
            } else {
                if (styles.top !== '0px' || styles.bottom !== '0px' || styles.left !== '0px' || styles.right !== '0px') return false;
            }
        } else {

            if (!matrix) return false;
            if (!valueMatch(matrix[12], desiredX)) return false;
            if (!valueMatch(matrix[13], desiredY)) return false;
        }
    }

    return true;
}

var validateRotate = function(matrix, desiredAngle) {
    var angle = 0;

    if(matrix) {
        var rawAngle = Math.round(Math.atan2(matrix[1], matrix[0]) * (180/Math.PI));
        angle = (rawAngle < 0) ? rawAngle + 360 : rawAngle;
        angle = angle % 90;
    } 

    if(typeof desiredAngle == 'number') {
        if (angle !== desiredAngle) return false;
    } else if (Array.isArray(desiredAngle)) {
        if (angle < desiredAngle[0]) return false;
        if (angle > desiredAngle[1]) return false;
    }

    return true;
}

var validateRotateX = function(matrix, desiredAngle) {
    var angle = 0;

    if(matrix) {
        var rawAngle = Math.round(Math.atan2(matrix[6], matrix[6]) * (180/Math.PI));
        angle = (rawAngle < 0) ? rawAngle + 360 : rawAngle;
        angle = angle % 90;
    } 

    if(typeof desiredAngle == 'number') {
        if (angle !== desiredAngle) return false;
    } else if (Array.isArray(desiredAngle)) {
        if (angle < desiredAngle[0]) return false;
        if (angle > desiredAngle[1]) return false;
    }

    return true;
}

var validateRotateY = function(matrix, desiredAngle) {
    var angle = 0;

    if(matrix) {
        var rawAngle = Math.round(Math.atan2(matrix[2], matrix[2]) * (180/Math.PI));
        angle = (rawAngle < 0) ? rawAngle + 360 : rawAngle;
        angle = angle % 90;
        angle = matrix[2] < 0 ? angle*-1 : angle;
    } 

    if(typeof desiredAngle == 'number') {
        if (angle !== desiredAngle) return false;
    } else if (Array.isArray(desiredAngle)) {
        if (angle < desiredAngle[0]) return false;
        if (angle > desiredAngle[1]) return false;
    }

    return true;
}

var validateSkew = function(el, ratioX, ratioY) {
    var scaleX = (el.getBoundingClientRect().width / el.offsetWidth).toFixed(1);
    var scaleY = (el.getBoundingClientRect().height / el.offsetHeight).toFixed(1);

    if (scaleX !== parseFloat(ratioX).toFixed(1)) return false;
    if (scaleY !== parseFloat(ratioY).toFixed(1)) return false;
    return true;
}

var getMatrix = function(styles) {
    var raw = styles.getPropertyValue('transform');
    var is3D = raw.includes('matrix3d');
    var matrix = null

    if(is3D) {
        matrix = styles.getPropertyValue('transform').replace('matrix3d(', '');
    } else {
        matrix = styles.getPropertyValue('transform').replace('matrix(', '');
    }

    matrix = matrix.replace(')', '').split(', ');

    matrix = matrix.length === 1 ? false : matrix;
    return matrix;
}

var valueMatch = function(value, target) { 
    if (Array.isArray(target)) {
        if (value > target[0]) return false;
        if (value < target[1]) return false;
    } else {
        if (value !== target) return false;
    }
    return true;
}

// Create an observer instance linked to the callback function
const observer1 = new MutationObserver(callback);

// Start observing the target node for configured mutations
observer1.observe(document.head, config);

validate();