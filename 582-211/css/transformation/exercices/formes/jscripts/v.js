var popup = new AppendPopup({
    title: "Exercice r√©ussi!",
    text: "F√©licitation, vous ma√Ætrisez les transformations CSS",
    color: "#FF0080",
    background: "https://i.giphy.com/media/ToMjGpqrlNFdSWscdzO/giphy.webp",
    ascii:`MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNXXXXNWWMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWX00000000KNWMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWKO0KKKKKK0OOXWMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMXkO0KKKKKKK0O0WMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMKkO0KKKKKKK0OOXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMW0xO00KKKKKK0kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMW0xk00KKKKKK0kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMWWNNNWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMW0xk00KKKKKK0kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMWK000000KXWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWOdk00KKKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMNOkk00KKK0O0XWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWOdk00KKKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMW0xkO00KKK00kOXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWOdk00KKKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMW0xkO00KKKK0OxOWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNOdk00KKKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMW0dxO00KKKK00kxXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWOdkO0KKKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMXxdkO0KKKK00kx0WMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNkdkO00KKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMNkdxO00KKKK0OxkXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNkoxO00KKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMW0ddk00KKKK0Oxx0WMMMMMMMMMMMMMMMMMWNXK00000XNXxoxkO0KKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMXkdxO0KKKK00kdONMMMWNXKKKKKXWWWX0OkxkkkkkkkOkoldkO0KKKK00kkXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMWOdxO0KKKKK0OxkXWWXOkkkkkkkkO0OxdxkOOO0000OOxlldkO00KKK00kkKMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMKxxO0KKKKK0Okx0N0xxkOO0000OkxlloxkO00000000OdlokO00KKK00kkKMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMNkdk00KKKK00OxkOddkO0000000Oxlcldk000000000OxlokO00KKK0OkkKMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMW0dx00KKKKK00Oxl:dO0000K000Oko:cok00K0KK0000kook00KKKK0OkxKWMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMXxxO00KKKKK00Oo:dO0000KK00Oko::lk00KKKKKKK0kddO00KKK00Okx0WMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMW0dk000KKKKK00xloO0000KKK00Odc:lk00KKKKKKK0OddO0KKKK00Okx0WMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMKxxO00KKKKKK0kook000KKKK00OxlclxOO0000000OkddO0KKK000OkxONMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMNkdk00KKKKKK0OxdkOOOO0OOOkxdoccldxxxxxxxxddodO00K000OOkxkXMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMW0dkO00KKKKK0OkdxxxxxxxxxxdddoooddxxxxkxxxddxkO0000OOOkxxKMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMW0xkO000000000kxddoodkO0000000000000000000000OOOOOOOOOkxx0WMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMWOdkO00000000OOxolclxO0000KKKKKKKKKKKKKKKKKKKK0000OkkxxxxOWMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMNOdkO00000000OOkdc;:okOO0O0000000000000000KKKKKKKK000OkxdxXMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMNOdkO000000000Okkdc;:oxkkkkkkkkkkkkkkkkkOO00KKKKKKKK0000OxOXWMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMNOdkOO00000000OOkxdolclodddxxxxxxxxdddxxkOO000KKKKKKKK000OkkKWMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMNOdkOO000000000Okxxdolc::::cclllllccclodxkkO000KKKKKKK000OOxkXMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMNOdkOO0000KKK00OOkxxddoc:;,,'''''''..',:ldxkOO00KKKKK0000OOxd0WMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMWOdxkO0000KKKK00OOkkxxddolcc:::;;;;,,,'',cxkOO000KKK00000OkxdOWMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMW0dxkOO000KKKKK000OOkkxxxddooooolllllc::;:okOO00KKKK00000Okdd0WMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMWKddkOO0000KKKKK0000OOOkkkxxxxxxxxxdddoooodkO00000K00000OOxddKMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMXxoxkOO0000KKKKK000000OOOOkkkkkkkkkkxxxxxxkOO000000000OOkdokNMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMWOodkOOO000000KKK00000000OOOOOOOOOOOOOOkkkOOO0000000OOkkxod0WMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMKxoxkOO0000000000K000000000000000OOOOOOOOOOOO0000OOOkxxookNMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMWOodxkOOO00000000000KK0000000000000OOOOOOOOOOOOOOOkkxdolxXMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMXkodxkOOO0000000000KKKK00000000000OOOOOOOOOOOOkkkxddoldKWMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMWXxodxkOOOO00000000000000000000000OOOOOOOOkkkkxxddooldKWMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMWXxodxxkOOOO00000000000000000000OOOOOOkkkkxxxddoollxXMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMXkoodxxkkOOOOO000000000000000OOOOOkkkxxxdddoolloONMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMWKxooddxxkkOOOOOO000000000OOOOOkkkxxdddooolllxKWMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWKkoloodxxxkkkOOOOOOOOOOOOOkkxxdddooollcld0NMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXOdolloodddxxxxkkkkkkkxxxddooolllccokKNMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXOkxoolllllooooooooollllccccldk0NWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNXK0OOkkkkkxxxxxxxxkkO0KNWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWWWWWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM`});

var style = document.createElement('style');
style.innerHTML = `
html,
body {
  margin: 0;
  height: 100%;
}
body {
    background-repeat: no-repeat;
    background-image: url(https://tim-montmorency.com/timdoc/582-215MO/css/transformation/exercices/formes/images/v.png);
    background-position: 50% 50%;
    background-size: 670px auto;
}
.slide {
    width: 200px;
    height: 200px;
    opacity: 0.5;
}
.slide.blue { background-color: #3c38ba;}
.slide.green { background-color: #00c774;}
.slide.red { background-color: #ff8487;}`;

document.head.appendChild(style);

class Shape {
    constructor(el, requirements) {
        this.dom = {
            el: document.querySelector(el)
        }

        this.requirements = requirements;

        this.init();
    }

    init() {
        this.calculateShape();
        this.getValues();
    }

    calculateShape() {
        this.rect = this.dom.el.getBoundingClientRect();
        this.styles = window.getComputedStyle(this.dom.el, null);
        this.matrix = this.styles.transform
            .split('(')[1]
            .split(')')[0]
            .split(',')
            .map(parseFloat);
        /* Matrix
        0: scaleX
        1: skewY
        2: skewX
        3: scaleY
        4: translateX
        5: translateY 
        */
    }

    getValues() {
        this.getRotate();
        this.translateX = this.matrix[4];
        this.translateY = this.matrix[5];
        this.scaleX = this.matrix[0];
        this.scaleY = this.matrix[3];
        this.scale = this.scaleX === this.scaleY ? this.scaleX : null;
        this.getSkew();
    }

    update() {
        this.calculateShape();
        this.getValues();
    }

    getRotate() {
        const rawAngle = Math.round(Math.atan2(this.matrix[1], this.matrix[0]) * (180/Math.PI));
        let angle = (rawAngle < 0) ? rawAngle + 360 : rawAngle;
        this.rotate = angle % 90;
    }

    getSkew() {
        const denom = Math.pow(this.matrix[0], 2) + Math.pow(this.matrix[1], 2);
        const skewX = Math.atan2(this.matrix[0] * this.matrix[2] + this.matrix[1] * this.matrix[3], denom);
        this.skew = this.skewX = Math.round(skewX / (Math.PI / 180));
    }

    validate() {
        let valid = true;

        console.log(this.dom.el, this.rotate, this.translateX, this.translateY);

        if (this.requirements.rotate !== undefined) {
            if (this.requirements.rotate !== this.rotate) valid = false;
        }

        if (this.requirements.translateX !== undefined) {
            if (this.requirements.translateX !== this.translateX) valid = false;
        }

        if (this.requirements.translateY !== undefined) {
            if (this.requirements.translateY !== this.translateY) valid = false;
        }

        if (this.requirements.scaleX !== undefined) {
            if (this.requirements.scaleX !== this.scaleX) valid = false;
        }

        if (this.requirements.scaleY !== undefined) {
            if (this.requirements.scaleY !== this.scaleY) valid = false;
        }

        if (this.requirements.skew !== undefined) {
            if (this.requirements.skew !== this.skew) valid = false;
        }

        if (this.requirements.skewX !== undefined) {
            if (this.requirements.skewX !== this.skewX) valid = false;
        }

        return valid;
    }
}

class Challenge {
    constructor() {
        this.red = new Shape('.slide.red', {
            rotate: 45,
            translateX: 0,
            translateY: 0
        });

        this.blue = new Shape('.slide.blue', {
            rotate: 45,
            translateX: 0,
            translateY: 0
        });

        this.green = new Shape('.slide.green', {
            rotate: 45,
            translateX: -141.421,
            translateY: -141.421
        });

        this.observer = new MutationObserver(() => this.validate());

        this.init();
    }

    init() {
        this.bindEvents();
        this.validate();
    }

    bindEvents() {
        this.observer.observe(document.head, { attributes: true, childList: true, subtree: true });
    }

    validate() {
        this.red.update();
        const red = this.red.validate();

        this.blue.update();
        const blue = this.blue.validate();

        this.green.update();
        const green = this.green.validate(); 

        console.log(` ${red ? '‚úÖ' : '‚ùå'}üî¥`, '\n', `${blue ? '‚úÖ' : '‚ùå'}üîµ`, '\n', `${green ? '‚úÖ' : '‚ùå'}üü¢`);

        if (red && blue && green) popup.open();
    }

    debounce(func, wait, immediate) {
        let timeout;
        return function() {
            const context = this, args = arguments;
            const later = function() {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            const callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    };
}

const challenge = new Challenge();